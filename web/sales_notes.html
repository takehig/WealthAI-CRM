{% extends "base.html" %}

{% block title %}営業メモ一覧 - WealthAI CRM{% endblock %}
{% block header %}営業メモ一覧{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">営業メモ一覧</h5>
        <button type="button" class="btn btn-primary" onclick="showAddModal()">
            <i class="fas fa-plus"></i> 新規追加
        </button>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="salesNotesTable" style="width: 100%; min-width: 1200px;">
                <thead class="table-light">
                    <tr>
                        <th onclick="sortTable(0)" style="width: 60px; min-width: 60px;">メモID <i class="fas fa-sort"></i></th>
                        <th onclick="sortTable(1)" style="width: 120px; min-width: 120px;">顧客名 <i class="fas fa-sort"></i></th>
                        <th onclick="sortTable(2)" style="width: calc(100% - 280px); min-width: 400px;">内容 <i class="fas fa-sort"></i></th>
                        <th onclick="sortTable(3)" style="width: 80px; min-width: 80px;">作成日 <i class="fas fa-sort"></i></th>
                        <th style="width: 80px; min-width: 80px;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for note in sales_notes %}
                    <tr>
                        <td style="width: 60px; min-width: 60px;">{{ note.customer_id }}</td>
                        <td style="width: 120px; min-width: 120px; word-wrap: break-word;">{{ note.customer_name }}</td>
                        <td style="width: calc(100% - 280px); min-width: 400px;">
                            <div id="content-preview-{{ note.customer_id }}" style="width: 100%; max-height: 120px; overflow-y: auto; word-wrap: break-word; white-space: pre-wrap; line-height: 1.4; padding: 8px; border: 1px solid #e9ecef; border-radius: 4px; background-color: #f8f9fa;">{{ note.content[:300] }}{% if note.content|length > 300 %}...{% endif %}</div>
                            {% if note.content|length > 300 %}
                            <div id="content-full-{{ note.customer_id }}" style="display: none; width: 100%; word-wrap: break-word; white-space: pre-wrap; line-height: 1.4; padding: 8px; border: 1px solid #e9ecef; border-radius: 4px; background-color: #f8f9fa;">{{ note.content }}</div>
                            <button class="btn btn-sm btn-link p-0 mt-1" onclick="toggleContent({{ note.customer_id }})">
                                <span id="toggle-text-{{ note.customer_id }}">全文表示</span>
                            </button>
                            {% endif %}
                        </td>
                        <td style="width: 80px; min-width: 80px;">{{ note.created_at.strftime('%m-%d') if note.created_at else '-' }}</td>
                        <td style="width: 80px; min-width: 80px;">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="editNote({{ note.customer_id }}, '{{ note.content|replace("'", "\\'") }}', {{ note.customer_id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteNote({{ note.customer_id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 追加・編集モーダル -->
<div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="noteModalTitle">営業メモ追加</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="noteForm">
                    <input type="hidden" id="noteId" value="">
                    <div class="mb-3" id="customerSelectDiv">
                        <label for="customerSelect" class="form-label">顧客</label>
                        <select class="form-control" id="customerSelect" required>
                            <option value="">顧客を選択してください</option>
                            {% for customer in customers %}
                            <option value="{{ customer.customer_id }}">{{ customer.customer_id }} - {{ customer.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3" id="customerDisplayDiv" style="display: none;">
                        <label class="form-label">顧客</label>
                        <input type="text" class="form-control" id="customerDisplay" readonly>
                        <input type="hidden" id="customerId">
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">内容</label>
                        <textarea class="form-control" id="content" rows="8" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="saveNote()">保存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function sortTable(n) {
    var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
    table = document.getElementById("salesNotesTable");
    switching = true;
    dir = "asc";
    while (switching) {
        switching = false;
        rows = table.rows;
        for (i = 1; i < (rows.length - 1); i++) {
            shouldSwitch = false;
            x = rows[i].getElementsByTagName("TD")[n];
            y = rows[i + 1].getElementsByTagName("TD")[n];
            if (dir == "asc") {
                if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                    shouldSwitch = true;
                    break;
                }
            } else if (dir == "desc") {
                if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                    shouldSwitch = true;
                    break;
                }
            }
        }
        if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
            switchcount++;
        } else {
            if (switchcount == 0 && dir == "asc") {
                dir = "desc";
                switching = true;
            }
        }
    }
}

function toggleContent(customerId) {
    const preview = document.getElementById(`content-preview-${customerId}`);
    const full = document.getElementById(`content-full-${customerId}`);
    const toggleText = document.getElementById(`toggle-text-${customerId}`);
    
    if (full.style.display === 'none') {
        preview.style.display = 'none';
        full.style.display = 'block';
        toggleText.textContent = '省略表示';
    } else {
        preview.style.display = 'block';
        full.style.display = 'none';
        toggleText.textContent = '全文表示';
    }
}

function showAddModal() {
    document.getElementById('noteModalTitle').textContent = '営業メモ追加';
    document.getElementById('noteId').value = '';
    document.getElementById('customerSelect').value = '';
    document.getElementById('content').value = '';
    
    // 新規追加時は顧客選択を表示
    document.getElementById('customerSelectDiv').style.display = 'block';
    document.getElementById('customerDisplayDiv').style.display = 'none';
    
    new bootstrap.Modal(document.getElementById('noteModal')).show();
}

function editNote(customerId, content, customerIdParam) {
    document.getElementById('noteModalTitle').textContent = '営業メモ編集';
    document.getElementById('noteId').value = customerId;
    document.getElementById('content').value = content;
    
    // 編集時は顧客名を表示（編集不可）
    const customerSelect = document.getElementById('customerSelect');
    const selectedOption = customerSelect.querySelector(`option[value="${customerId}"]`);
    const customerName = selectedOption ? selectedOption.textContent : `顧客ID: ${customerId}`;
    
    document.getElementById('customerDisplay').value = customerName;
    document.getElementById('customerId').value = customerId;
    
    document.getElementById('customerSelectDiv').style.display = 'none';
    document.getElementById('customerDisplayDiv').style.display = 'block';
    
    new bootstrap.Modal(document.getElementById('noteModal')).show();
}

async function saveNote() {
    const customerId = document.getElementById('noteId').value;
    const content = document.getElementById('content').value;
    
    let customerIdToUse;
    if (customerId) {
        // 編集時
        customerIdToUse = customerId;
    } else {
        // 新規追加時
        customerIdToUse = document.getElementById('customerSelect').value;
    }
    
    try {
        let response;
        if (customerId) {
            // 編集
            response = await fetch(`/api/sales-notes/${customerId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `content=${encodeURIComponent(content)}`
            });
        } else {
            // 新規追加
            response = await fetch('/api/sales-notes', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `customer_id=${customerIdToUse}&content=${encodeURIComponent(content)}`
            });
        }
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
            location.reload();
        } else {
            const error = await response.json();
            alert('保存に失敗しました: ' + (error.detail || '不明なエラー'));
        }
    } catch (error) {
        alert('保存に失敗しました: ' + error.message);
    }
}

async function deleteNote(customerId) {
    if (!confirm('このメモを削除しますか？')) return;
    
    try {
        const response = await fetch(`/api/sales-notes/${customerId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert('削除に失敗しました: ' + (error.detail || '不明なエラー'));
        }
    } catch (error) {
        alert('削除に失敗しました: ' + error.message);
    }
}
</script>
{% endblock %}
