{% extends "base.html" %}

{% block title %}営業メモ一覧 - WealthAI CRM{% endblock %}
{% block header %}営業メモ一覧{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">営業メモ一覧</h5>
        <button type="button" class="btn btn-primary" onclick="showAddModal()">
            <i class="fas fa-plus"></i> 新規追加
        </button>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="salesNotesTable" style="table-layout: fixed; width: 100%;">
                <thead class="table-light">
                    <tr>
                        <th onclick="sortTable(0)" style="width: 80px;">メモID <i class="fas fa-sort"></i></th>
                        <th onclick="sortTable(1)" style="width: 150px;">顧客名 <i class="fas fa-sort"></i></th>
                        <th onclick="sortTable(2)" style="width: auto;">内容 <i class="fas fa-sort"></i></th>
                        <th onclick="sortTable(3)" style="width: 100px;">作成日 <i class="fas fa-sort"></i></th>
                        <th style="width: 100px;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for note in sales_notes %}
                    <tr>
                        <td style="width: 80px;">{{ note.note_id }}</td>
                        <td style="width: 150px; word-wrap: break-word;">{{ note.customer_name }}</td>
                        <td>
                            <div id="content-preview-{{ note.note_id }}" style="max-width: 600px; max-height: 120px; overflow-y: auto; word-wrap: break-word; white-space: pre-wrap; line-height: 1.4;">
                                {{ note.content[:300] }}{% if note.content|length > 300 %}...{% endif %}
                            </div>
                            {% if note.content|length > 300 %}
                            <div id="content-full-{{ note.note_id }}" style="display: none; max-width: 600px; word-wrap: break-word; white-space: pre-wrap; line-height: 1.4;">
                                {{ note.content }}
                            </div>
                            <button class="btn btn-sm btn-link p-0 mt-1" onclick="toggleContent({{ note.note_id }})">
                                <span id="toggle-text-{{ note.note_id }}">全文表示</span>
                            </button>
                            {% endif %}
                        </td>
                        <td style="width: 100px;">{{ note.created_at.strftime('%Y-%m-%d') if note.created_at else '-' }}</td>
                        <td style="width: 100px;">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="editNote({{ note.note_id }}, '{{ note.content|replace("'", "\\'") }}', {{ note.customer_id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteNote({{ note.note_id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 追加・編集モーダル -->
<div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="noteModalTitle">営業メモ追加</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="noteForm">
                    <input type="hidden" id="noteId" value="">
                    <div class="mb-3">
                        <label for="customerId" class="form-label">顧客ID</label>
                        <input type="number" class="form-control" id="customerId" required>
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">内容</label>
                        <textarea class="form-control" id="content" rows="8" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="saveNote()">保存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function sortTable(n) {
    var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
    table = document.getElementById("salesNotesTable");
    switching = true;
    dir = "asc";
    while (switching) {
        switching = false;
        rows = table.rows;
        for (i = 1; i < (rows.length - 1); i++) {
            shouldSwitch = false;
            x = rows[i].getElementsByTagName("TD")[n];
            y = rows[i + 1].getElementsByTagName("TD")[n];
            if (dir == "asc") {
                if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                    shouldSwitch = true;
                    break;
                }
            } else if (dir == "desc") {
                if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                    shouldSwitch = true;
                    break;
                }
            }
        }
        if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
            switchcount++;
        } else {
            if (switchcount == 0 && dir == "asc") {
                dir = "desc";
                switching = true;
            }
        }
    }
}

function toggleContent(noteId) {
    const preview = document.getElementById(`content-preview-${noteId}`);
    const full = document.getElementById(`content-full-${noteId}`);
    const toggleText = document.getElementById(`toggle-text-${noteId}`);
    
    if (full.style.display === 'none') {
        preview.style.display = 'none';
        full.style.display = 'block';
        toggleText.textContent = '省略表示';
    } else {
        preview.style.display = 'block';
        full.style.display = 'none';
        toggleText.textContent = '全文表示';
    }
}

function showAddModal() {
    document.getElementById('noteModalTitle').textContent = '営業メモ追加';
    document.getElementById('noteId').value = '';
    document.getElementById('customerId').value = '';
    document.getElementById('content').value = '';
    new bootstrap.Modal(document.getElementById('noteModal')).show();
}

function editNote(noteId, content, customerId) {
    document.getElementById('noteModalTitle').textContent = '営業メモ編集';
    document.getElementById('noteId').value = noteId;
    document.getElementById('customerId').value = customerId;
    document.getElementById('content').value = content;
    new bootstrap.Modal(document.getElementById('noteModal')).show();
}

async function saveNote() {
    const noteId = document.getElementById('noteId').value;
    const customerId = document.getElementById('customerId').value;
    const content = document.getElementById('content').value;
    
    try {
        let response;
        if (noteId) {
            // 編集
            response = await fetch(`/api/sales-notes/${noteId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `content=${encodeURIComponent(content)}`
            });
        } else {
            // 新規追加
            response = await fetch('/api/sales-notes', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `customer_id=${customerId}&content=${encodeURIComponent(content)}`
            });
        }
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
            location.reload();
        } else {
            const error = await response.json();
            alert('保存に失敗しました: ' + (error.detail || '不明なエラー'));
        }
    } catch (error) {
        alert('保存に失敗しました: ' + error.message);
    }
}

async function deleteNote(noteId) {
    if (!confirm('このメモを削除しますか？')) return;
    
    try {
        const response = await fetch(`/api/sales-notes/${noteId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert('削除に失敗しました: ' + (error.detail || '不明なエラー'));
        }
    } catch (error) {
        alert('削除に失敗しました: ' + error.message);
    }
}
</script>
{% endblock %}
