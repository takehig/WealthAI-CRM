<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>データベース管理 v{{ version }} - Enterprise Systems</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .query-container {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
        }
        .result-container {
            background-color: #1e1e1e;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
            border-radius: 5px;
            padding: 15px;
        }
        .db-selector {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .table-info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-database me-2"></i>
                    データベース管理システム v{{ version }}
                </h1>
                
                <!-- データベース選択 -->
                <div class="db-selector">
                    <h5><i class="fas fa-server me-2"></i>データベース選択</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <select id="database-selector" class="form-select form-select-lg">
                                {% for key, db in databases.items() %}
                                <option value="{{ key }}">{{ db.name }} - {{ db.description }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <button id="load-tables" class="btn btn-light btn-lg">
                                <i class="fas fa-table me-2"></i>テーブル一覧取得
                            </button>
                        </div>
                    </div>
                </div>

                <!-- テーブル情報 -->
                <div id="table-info" class="table-info" style="display: none;">
                    <h6><i class="fas fa-list me-2"></i>テーブル一覧</h6>
                    <div id="tables-list"></div>
                </div>

                <!-- SQL実行 -->
                <div class="query-container">
                    <h5><i class="fas fa-code me-2"></i>SQL実行</h5>
                    <form id="sql-form">
                        <div class="mb-3">
                            <label class="form-label">SQLクエリ</label>
                            <textarea id="sql-query" class="form-control" rows="8" 
                                placeholder="SELECT * FROM customers LIMIT 10;"></textarea>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-play me-2"></i>実行
                            </button>
                            <button type="button" id="clear-query" class="btn btn-secondary">
                                <i class="fas fa-eraser me-2"></i>クリア
                            </button>
                            <button type="button" id="sample-query" class="btn btn-info">
                                <i class="fas fa-lightbulb me-2"></i>サンプル
                            </button>
                        </div>
                    </form>
                </div>

                <!-- 実行結果 -->
                <div id="result-section" class="mt-4" style="display: none;">
                    <h5><i class="fas fa-chart-bar me-2"></i>実行結果</h5>
                    <div id="result-info" class="alert alert-info"></div>
                    <div id="result-container" class="result-container"></div>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-5 text-center text-muted">
        <small>Database Management System v{{ version }} - 複数データベース対応</small>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentDatabase = 'wealthai';

        // データベース選択変更
        document.getElementById('database-selector').addEventListener('change', function() {
            currentDatabase = this.value;
            document.getElementById('table-info').style.display = 'none';
            console.log('Selected database:', currentDatabase);
        });

        // テーブル一覧取得
        document.getElementById('load-tables').addEventListener('click', async function() {
            try {
                const response = await fetch(`/api/tables/${currentDatabase}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const tablesList = document.getElementById('tables-list');
                    tablesList.innerHTML = data.tables.map(table => 
                        `<span class="badge bg-primary me-2 mb-1">${table.table_name}</span>`
                    ).join('');
                    
                    document.getElementById('table-info').style.display = 'block';
                } else {
                    alert('テーブル取得エラー: ' + data.error);
                }
            } catch (error) {
                alert('エラー: ' + error.message);
            }
        });

        // SQL実行
        document.getElementById('sql-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const query = document.getElementById('sql-query').value.trim();
            if (!query) {
                alert('SQLクエリを入力してください');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('database', currentDatabase);
                formData.append('query', query);

                const response = await fetch('/api/execute', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                displayResult(data);
                
            } catch (error) {
                displayResult({
                    status: 'error',
                    error: error.message
                });
            }
        });

        // 結果表示
        function displayResult(data) {
            const resultSection = document.getElementById('result-section');
            const resultInfo = document.getElementById('result-info');
            const resultContainer = document.getElementById('result-container');
            
            resultSection.style.display = 'block';
            
            if (data.status === 'success') {
                if (data.type === 'select') {
                    resultInfo.className = 'alert alert-success';
                    resultInfo.innerHTML = `
                        <strong>実行成功</strong> - ${data.database}<br>
                        取得件数: ${data.row_count}件 | 実行時間: ${data.execution_time}秒
                    `;
                    
                    if (data.data.length > 0) {
                        const table = createTable(data.columns, data.data);
                        resultContainer.innerHTML = table;
                    } else {
                        resultContainer.innerHTML = '<p>結果がありません</p>';
                    }
                } else {
                    resultInfo.className = 'alert alert-success';
                    resultInfo.innerHTML = `
                        <strong>実行成功</strong> - ${data.database}<br>
                        影響行数: ${data.affected_rows}行 | 実行時間: ${data.execution_time}秒
                    `;
                    resultContainer.innerHTML = '<p>クエリが正常に実行されました</p>';
                }
            } else {
                resultInfo.className = 'alert alert-danger';
                resultInfo.innerHTML = `<strong>エラー</strong> - ${data.database || 'Unknown'}<br>${data.error}`;
                resultContainer.innerHTML = '';
            }
        }

        // テーブル作成
        function createTable(columns, data) {
            let html = '<table class="table table-sm table-dark table-striped">';
            
            // ヘッダー
            html += '<thead><tr>';
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead>';
            
            // データ
            html += '<tbody>';
            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    const value = row[col];
                    html += `<td>${value !== null ? value : '<em>NULL</em>'}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            
            return html;
        }

        // クリアボタン
        document.getElementById('clear-query').addEventListener('click', function() {
            document.getElementById('sql-query').value = '';
        });

        // サンプルクエリ
        document.getElementById('sample-query').addEventListener('click', function() {
            const samples = {
                'wealthai': 'SELECT c.customer_name, COUNT(h.holding_id) as holdings_count\nFROM customers c\nLEFT JOIN holdings h ON c.customer_id = h.customer_id\nGROUP BY c.customer_id, c.customer_name\nORDER BY holdings_count DESC\nLIMIT 5;',
                'productmaster': 'SELECT product_type, COUNT(*) as count, AVG(CAST(price AS NUMERIC)) as avg_price\nFROM products\nWHERE price IS NOT NULL\nGROUP BY product_type\nORDER BY count DESC;',
                'aichat': 'SELECT prompt_key, LENGTH(prompt_text) as text_length, updated_at\nFROM system_prompts\nORDER BY updated_at DESC;'
            };
            
            document.getElementById('sql-query').value = samples[currentDatabase] || 'SELECT * FROM information_schema.tables LIMIT 10;';
        });

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            currentDatabase = document.getElementById('database-selector').value;
        });
    </script>
</body>
</html>
