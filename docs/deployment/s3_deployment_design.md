# S3経由デプロイメント設計

## 現在の問題点（scp方式）
- ❌ ローカル環境からEC2への直接転送（セキュリティリスク）
- ❌ ネットワーク障害時の転送失敗
- ❌ 大きなファイルの転送時間
- ❌ バージョン管理なし
- ❌ 複数EC2への同時デプロイ困難
- ❌ ロールバック機能なし

## S3経由の利点
- ✅ セキュアな転送（IAMロール使用）
- ✅ 高可用性・高耐久性
- ✅ バージョニング対応
- ✅ 複数インスタンスへの配布
- ✅ ロールバック機能
- ✅ CI/CDパイプライン対応
- ✅ 転送ログ・監査証跡

## 提案アーキテクチャ

### Option 1: シンプルS3デプロイ
```
ローカル環境 → S3バケット → EC2インスタンス
    ↓              ↓           ↓
1. zip作成      2. アップロード  3. ダウンロード&展開
2. S3アップロード              4. サービス再起動
```

### Option 2: CodeDeploy使用
```
ローカル環境 → S3バケット → CodeDeploy → EC2インスタンス
    ↓              ↓           ↓           ↓
1. zip作成      2. アーティファクト 3. 自動デプロイ  4. アプリケーション更新
2. S3アップロード  保存           4. ヘルスチェック 5. ロールバック対応
```

### Option 3: GitHub Actions + S3
```
GitHub → GitHub Actions → S3バケット → EC2インスタンス
   ↓           ↓              ↓           ↓
1. git push  2. 自動ビルド    3. アーティファクト 4. 自動デプロイ
             3. テスト実行    保存           5. 通知
             4. S3アップロード
```

## 推奨: Option 1 (シンプルS3デプロイ)

### 必要なAWSリソース
1. **S3バケット**: `wealthai-deployments`
2. **IAMロール**: EC2用（S3読み取り権限）
3. **IAMポリシー**: ローカル用（S3書き込み権限）

### デプロイフロー
```bash
# 1. ローカルでアーティファクト作成
./scripts/build-artifact.sh

# 2. S3にアップロード
aws s3 cp wealthai-v1.0.0.zip s3://wealthai-deployments/releases/

# 3. EC2で自動デプロイ
ssh ec2 "sudo /opt/wealthai/deploy-from-s3.sh v1.0.0"
```

## 実装計画

### Phase 1: S3バケット・IAM設定
- S3バケット作成
- IAMロール・ポリシー設定
- EC2にIAMロール割り当て

### Phase 2: デプロイスクリプト作成
- アーティファクト作成スクリプト
- S3アップロードスクリプト
- EC2デプロイスクリプト

### Phase 3: 自動化・CI/CD
- GitHub Actions設定
- 自動テスト追加
- 通知機能追加

## セキュリティ考慮事項
- S3バケットはプライベート
- IAMロールによる最小権限
- バージョニング有効化
- 暗号化設定（AES-256）
- アクセスログ記録

## コスト影響
- S3ストレージ: ~$0.1/月（小さなアーティファクト）
- データ転送: ~$1/月
- 追加コスト: ほぼなし

次のステップ: S3バケット作成から始めますか？
